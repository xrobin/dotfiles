#!/bin/bash
# Checks consistency of SOA records of domain across the name servers
# Usage: check_SOA example.com
domain=$1
if [ -z $domain ]; then
	>&2 echo "Usage: check_SOA example.com"
	exit 1
fi

>&2 echo "Checking domain $domain..."
NSes=$(dig NS $domain +short)

# Get the primary:
primary_NS=$(dig +short SOA $domain | cut -d' ' -f1)
primary_result=$(dig @$primary_NS SOA $domain +short)

# Find the longest NS name
maxlen=0
for NS in $NSes; do
    newlen=${#NS}
    ((newlen > maxlen)) && maxlen=$newlen
done

exit_code=0
for NS in $NSes; do
    result=$(dig @$NS SOA $domain +short)
    printf "%${maxlen}s: %s\n" "$NS" "$result"
    if [ ! -z "$previous_result" ] && [ "$previous_result" !=  "$result" ]; then
        >&2 echo "error in $NS: differs from primary!"
	exit_code=$((exit_code+1))
    fi
    previous_result="$result"
done

exit $exit_code

